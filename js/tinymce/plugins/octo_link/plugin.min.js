tinymce.PluginManager.add("octo_link",function(t){function e(){var e="",n='<div class="mce-not-inline mce-menu-item mce-menu-item-normal mce-first mce-stack-layout-item mce-link-row">',i="</div>";return e+=n+'<span class="mce-input-name-txt">link</span> <input id="'+t.id+'_octPostLinkListField" type="text" name="href" value="">'+i,e+='<div style="display: none;" id="'+t.id+'octPostLinkList" class="octPostLinkList" data-postlink-to="#'+t.id+'_octPostLinkListField"></div>',e+=n+'<span class="mce-input-name-txt">title</span> <input type="text" name="title" value="">'+i,e+=n+'<input type="checkbox" name="target_blank" value="1"> <span class="mce-input-name-txt">open link in a new window</span>'+i}function n(t){return t.control.panel?t.control.panel:t.control}function i(e){function i(e,n){var i=t.selection.getRng();window.setTimeout(function(){t.windowManager.confirm(e,function(e){t.selection.setRng(i),n(e)})},0)}function a(){var n={href:o,target:c.target?c.target:null,rel:c.rel?c.rel:null,"class":c["class"]?c["class"]:null,title:c.title?c.title:null};if(s._lastAnchorElm)t.focus(),r.setAttribs(s._lastAnchorElm,n),s._lastSelection.select(s._lastAnchorElm),t.undoManager.add();else if(s._lastOnlyText){var i=r.createHTML("a",n,r.encode(s._lastSelContent));t.insertContent(i),t._lastCreatedNode||console.error("Can not find last inserted node for "+i),s._lastSelection.select(t._lastCreatedNode),l(e)}else t.execCommand("mceInsertLink",!1,n);s._lastLinkSet=(new Date).getMilliseconds()}var o,s=n(e),c={},r=t.dom,d=jQuery("#"+s._id),u=d.find('[name="href"]'),f=d.find('[name="title"]'),m=d.find('[name="target_blank"]');return c.href=u.val(),c.title=f.val(),c.target=m.attr("checked")?"_blank":null,(o=c.href)?o.indexOf("@")>0&&-1==o.indexOf("//")&&-1==o.indexOf("mailto:")?void i("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(t){t&&(o="mailto:"+o),a()}):void a():void t.execCommand("unlink")}function l(e){var i=n(e),l=t.dom,o=t.selection.getNode();i._lastAnchorElm=l.getParent(o,"a[href]"),i._lastOnlyText=a(i._lastAnchorElm),i._lastSelContent=t.selection.getContent(),i._lastSelNode=t.selection.getNode(),i._lastSelection=t.selection}function a(e){var n=t.selection.getContent();if(/</.test(n)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(n)||-1==n.indexOf("href=")))return!1;if(e){var i,l=e.childNodes;if(0===l.length)return!1;for(i=l.length-1;i>=0;i--)if(3!=l[i].nodeType)return!1}return!0}function o(e){if(e.control.panel){var a,o={},s=t.dom,c=jQuery("#"+e.control.panel._id),r=c.is(":visible"),d=c.find('[name="href"]'),u=c.find('[name="title"]'),f=c.find('[name="target_blank"]');if(r){var m=n(e);m._octInited||(d.change(function(){i(e)}).click(function(){var t=(new Date).getMilliseconds();m._lastLinkSet&&t-m._lastLinkSet<=100&&jQuery(this).focus()}),u.change(function(){i(e)}).click(function(){var t=(new Date).getMilliseconds();m._lastLinkSet&&t-m._lastLinkSet<=100&&jQuery(this).focus()}),f.change(function(){i(e)}),octInitCustomCheckRadio(c),m._octInited=!0),l(e),o.href=m._lastAnchorElm?s.getAttrib(m._lastAnchorElm,"href"):"",m._lastAnchorElm?o.target=s.getAttrib(m._lastAnchorElm,"target"):t.settings.default_link_target&&(o.target=t.settings.default_link_target),(a=s.getAttrib(m._lastAnchorElm,"rel"))&&(o.rel=a),(a=s.getAttrib(m._lastAnchorElm,"class"))&&(o["class"]=a),(a=s.getAttrib(m._lastAnchorElm,"title"))&&(o.title=a),d.val(o.href),u.val(o.title?o.title:""),"_blank"==o.target?f.attr("checked","checked"):f.removeAttr("checked"),octCheckUpdate(f)}}}var s=null,c=null;t.addButton("octo_link",{type:"panelbutton",icon:"link",tooltip:"Insert/edit link",shortcut:"Meta+K",onclick:o,stateSelector:"a[href]",panel:{role:"application",html:e,border:1,onshow:function(){var e="#"+t.id+"_octPostLinkListField",n="#"+t.id+"octPostLinkList",i=jQuery(e),l=jQuery(n),a=i.parents(".mce-container");i.focus(function(){null===s&&(s=l.height()),null===c&&(c=a.height());var t=c+s;a.css("height",t),a.css("max-height",t)}),i.on("postlink.hide",function(){var t=c;a.css("height",t),a.css("max-height",t)})},onhide:function(e){var n="#"+t.id+"_octPostLinkListField",l=jQuery(n),a=l.parents(".mce-container"),o=c;a.css("height",o),a.css("max-height",o),i(e)}}})});